@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels


@{
    Layout = "master.cshtml";
}

@await Html.PartialAsync("~/Views/Partials/pageHeader.cshtml", new Clean.Core.Models.ViewModels.PageHeaderViewModel("Articles", "Articles", "Browse our articles", null))

<main class="mb-4">
    <div class="container px-4 px-lg-5" id="articles-app">
        <div class="row gx-4 gx-lg-5">
            <!-- Facets Sidebar (Left) -->
            <aside class="col-lg-3 col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Filters</h5>
                    </div>
                    <div class="card-body">
                        <!-- Search Input -->
                        <div class="mb-3">
                            <label for="search-input" class="form-label">Search</label>
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    id="search-input"
                                    class="form-control" 
                                    placeholder="Search articles..." 
                                    v-model="searchQuery"
                                    @@keyup.enter="search"
                                />
                                <button class="btn btn-primary" type="button" @@click="search">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Author Facet -->
                        <div v-if="authorFacet && authorFacet.values && authorFacet.values.length > 0" class="mb-3">
                            <h6 class="fw-bold">Author</h6>
                            <div class="form-check" v-for="value in authorFacet.values" :key="value.key">
                                <input 
                                    class="form-check-input" 
                                    type="checkbox" 
                                    :id="'author-' + value.key"
                                    :value="value.key"
                                    :checked="selectedAuthors.includes(value.key)"
                                    @@change="toggleAuthor(value.key)"
                                />
                                <label class="form-check-label" :for="'author-' + value.key">
                                    {{ value.key }} ({{ value.count }})
                                </label>
                            </div>
                        </div>

                        <!-- Category Facet -->
                        <div v-if="categoryFacet && categoryFacet.values && categoryFacet.values.length > 0" class="mb-3">
                            <h6 class="fw-bold">Category</h6>
                            <div class="form-check" v-for="value in categoryFacet.values" :key="value.key">
                                <input 
                                    class="form-check-input" 
                                    type="checkbox" 
                                    :id="'category-' + value.key"
                                    :value="value.key"
                                    :checked="selectedCategories.includes(value.key)"
                                    @@change="toggleCategory(value.key)"
                                />
                                <label class="form-check-label" :for="'category-' + value.key">
                                    {{ value.key }} ({{ value.count }})
                                </label>
                            </div>
                        </div>

                        <!-- Year Range Slider -->
                        <div v-if="yearFacet && availableYears.length > 0" class="mb-3">
                            <h6 class="fw-bold">Year Range</h6>
                            <div class="mb-2">
                                <label for="year-min" class="form-label small mb-1">From: {{ selectedMinYear }}</label>
                                <input 
                                    type="range" 
                                    id="year-min"
                                    class="form-range" 
                                    :min="yearRange.min"
                                    :max="yearRange.max"
                                    v-model.number="selectedMinYear"
                                    @@input="onYearRangeChange"
                                />
                            </div>
                            <div class="mb-2">
                                <label for="year-max" class="form-label small mb-1">To: {{ selectedMaxYear }}</label>
                                <input 
                                    type="range" 
                                    id="year-max"
                                    class="form-range" 
                                    :min="yearRange.min"
                                    :max="yearRange.max"
                                    v-model.number="selectedMaxYear"
                                    @@input="onYearRangeChange"
                                />
                            </div>
                            <div class="small text-muted">
                                Range: {{ yearRange.min }} - {{ yearRange.max }}
                            </div>
                        </div>

                        <!-- Clear Filters -->
                        <div v-if="selectedAuthors.length > 0 || selectedCategories.length > 0 || searchQuery || (selectedMinYear && selectedMaxYear && (selectedMinYear > yearRange.min || selectedMaxYear < yearRange.max))" class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm w-100" @@click="selectedAuthors = []; selectedCategories = []; searchQuery = ''; selectedMinYear = yearRange.min; selectedMaxYear = yearRange.max; search();">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Results (Right) -->
            <div class="col-lg-9 col-md-8">
                <!-- Loading State -->
                <div v-if="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading articles...</p>
                </div>

                <!-- Error State -->
                <div v-if="error && !loading" class="alert alert-danger" role="alert">
                    <strong>Error:</strong> {{ error }}
                </div>

                <!-- Results -->
                <div v-if="!loading && !error">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <h4 class="mb-2 mb-md-0">Found {{ total }} {{ total === 1 ? 'article' : 'articles' }}</h4>
                        
                        <!-- Sorting Dropdowns -->
                        <div class="d-flex gap-2 align-items-center">
                            <label for="sort-by" class="form-label mb-0">Sort by:</label>
                            <select 
                                id="sort-by"
                                class="form-select form-select-sm" 
                                v-model="sortBy"
                                @@change="onSortChange"
                                style="width: auto; min-width: 120px;"
                            >
                                <option value="relevance">Relevance</option>
                                <option value="title">Title</option>
                                <option value="date">Date</option>
                            </select>
                            
                            <label for="sort-direction" class="form-label mb-0">Order:</label>
                            <select 
                                id="sort-direction"
                                class="form-select form-select-sm" 
                                v-model="sortDirection"
                                @@change="onSortChange"
                                style="width: auto; min-width: 100px;"
                            >
                                <option value="desc">Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                        </div>
                    </div>

                    <!-- Articles List -->
                    <div v-if="articles.length > 0">
                        <div class="row g-4">
                            <div v-for="article in articles" :key="article.id" class="col-md-6">
                                <div class="post-preview mb-4 h-100">
                                    <a :href="article.route.path" class="text-decoration-none">
                                        <h2 class="post-title">{{ article.name }}</h2>
                                        <h3 v-if="article.properties.subtitle" class="post-subtitle">{{ article.properties.subtitle }}</h3>
                                    </a>
                                    
                                    <div v-if="getArticleImage(article)" class="mb-3">
                                        <img :src="getArticleImage(article)" :alt="article.name" class="img-fluid rounded" style="max-height: 250px; width: 100%; object-fit: cover;" />
                                    </div>

                                    <p class="post-meta" v-if="getAuthorName(article) || article.properties.articleDate">
                                        <span v-if="getAuthorName(article)">By {{ getAuthorName(article) }}</span>
                                        <span v-if="article.properties.articleDate">
                                            <span v-if="getAuthorName(article)"> • </span>
                                            {{ formatDate(article.properties.articleDate) }}
                                        </span>
                                    </p>

                                    <p v-if="getCategories(article)" class="text-muted small mb-2">
                                        <i class="fa fa-tags"></i> {{ getCategories(article) }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <hr class="mt-4">
                    </div>

                    <!-- No Results -->
                    <div v-else class="alert alert-info" role="alert">
                        No articles found. Try adjusting your filters.
                    </div>

                    <!-- Pagination (Below Results) -->
                    <nav v-if="totalPages > 1" aria-label="Article pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                                <a class="page-link" href="#" @@click.prevent="goToPage(currentPage - 1)" tabindex="-1">Previous</a>
                            </li>
                            <li 
                                v-for="page in totalPages" 
                                :key="page"
                                class="page-item" 
                                :class="{ active: currentPage === page }"
                            >
                                <a class="page-link" href="#" @@click.prevent="goToPage(page)">{{ page }}</a>
                            </li>
                            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                                <a class="page-link" href="#" @@click.prevent="goToPage(currentPage + 1)">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Vue 3 from CDN -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="/js/articles-app.js" asp-append-version="true"></script>
